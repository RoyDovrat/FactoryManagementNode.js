<!DOCTYPE html>
<html>
    <head>
        <script>
            const employeesURL = 'http://localhost:3000/employees';
            const departmentsURL = 'http://localhost:3000/departments';

            let departmentsData = [];
            let employeesData = [];

            //-------------- handle  fetch requests --------------
            const fetchData = async (url) => {
                const token = sessionStorage.getItem('token');

                try {
                    const resp = await fetch(`${url}`, {
                        headers: { 'x-access-token': token },
                    });
                    return await resp.json();
                } catch (error) {
                    console.log(`Fetch error for ${url}`);
                    alert('An error occurred while fetching data. Please try again.');
                }
            };
            

            const loadData = async () => {
                departmentsData = await fetchData(departmentsURL);
                employeesData = await fetchData(employeesURL);
            }

            //------add information to department table------
            const departmentTableInfo = async () => {
                const departmentTable = document.getElementById('departmentTable');
                departmentTable.innerHTML = '';

                departmentsData.forEach(department => {
                    const row = document.createElement('tr');
                    const departmentEmployees = employeesData.filter(emp => emp.DepartmentID === department._id);

                    const manager = employeesData.find(emp => emp._id === department.Manager);
                    const managerName = manager ? `${manager.FirstName} ${manager.LastName}` : 'Unknown';

                    const employeesNames = departmentEmployees.map(employee => 
                        `<a href="editEmployee.html?id=${employee._id}">${employee.FirstName} ${employee.LastName}</a>`
                    ).join(', '); 

                    row.innerHTML = `
                        <td><a href="editDepartment.html?id=${department._id}">${department.Name}</a></td>
                        <td>${managerName}</td>
                        <td>${employeesNames}</td>
                    `;
                    departmentTable.appendChild(row);
                });
            };
            //--------------------------------------------------

            const pageDisplay = async () => {
                const token = sessionStorage.getItem('token');
                const fullName = sessionStorage.getItem('fullName');

                if (!token) {
                    alert("Please log in first.");
                    location.href = 'loginPage.html'; 
                } else {
                    document.getElementById('fullName').innerText = fullName;
                    await loadData();
                    await departmentTableInfo(); 
                }
            };

            //------user log out------ 
            function logout() {
                sessionStorage.clear();
                location.href = 'loginPage.html'; 
            };
            //-------------------------
        </script>
    </head>

    <body onload="pageDisplay()">
        <h1>Department Page</h1>

        <!-- Display user's full name -->
        <p>Welcome, <span id="fullName"></span></p>
        <!------------------------------>

        <!--log out option-->
        <a href="#" onclick="logout()">Log Out</a><br><br>
        <!------------------->

        <!-- Table of departments -->
        <table border="1">
            <thead>
                <tr>
                    <th>Department name</th>
                    <th>Department manager name</th>
                    <th>Employees names</th>
                </tr>
            </thead>
            <tbody id="departmentTable">
            </tbody>
        </table> <br><br>
        <!------------------->

        <!-- add new depatment -->
        <button onclick="location.href='newDepartment.html'">Add Department</button> 
        <!---------------------->

    </body>
</html>
